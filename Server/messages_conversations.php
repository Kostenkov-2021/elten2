<?phprequire("header.php");if(!isset($_GET['sp'])) {if(!isset($_GET['user'])) {if(isset($_GET['limit']))$limit=$_GET['limit'];else$limit=1000;$q=mquery("select if(m.receiver='".mysql_real_escape_string($_GET['name'])."', m.sender, m.receiver) as user, m.sender, m.date, m.subject, if(m.`read`>0 and m.receiver='".mysql_real_escape_string($_GET['name'])."', 1, 0), m.id from messages m inner join ( select max(id) as maxid from messages where ( (receiver not like '[%]' and  (sender='".mysql_real_escape_string($_GET['name'])."' and deletedfromsent=0) or (receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromreceived=0) ) or receiver in (select groupid from messages_groups_members where user='".mysql_real_escape_string($_GET['name'])."') ) group by if(receiver='".mysql_real_escape_string($_GET['name'])."', sender, receiver) ) t on m.id=t.maxid group by user order by id desc limit 0,".((int)($limit+1)));$cnt=0;$txt="\r\n".((mysql_num_rows($q)>$limit)?1:0);while($r=mysql_fetch_row($q) and $cnt<$limit)if($r[0]!="") {++$cnt;$txt .= "\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4]."\r\n".$r[5];}echo "0\r\n".$cnt.$txt;//die;}elseif(isset($_GET['user']) and (!isset($_GET['subj']) and !isset($_GET['id']))) {if(isset($_GET['limit']))$limit=(int)$_GET['limit'];else$limit=1000;$q=mquery("select replace(lower(m.subject),'re: ','') as subject, m.sender, m.date, if(m.`read` is not null,1,0), m.id from messages m inner join ( select max(id) as maxid from messages where ( (sender='".mysql_real_escape_string($_GET['name'])."' and receiver='".mysql_real_escape_string($_GET['user'])."' and deletedfromsent=0) or (sender='".mysql_real_escape_string($_GET['user'])."' and receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromsent=0) or (receiver='".mysql_real_escape_string($_GET['user'])."' and receiver in (select groupid from messages_groups_members where user='".mysql_real_escape_string($_GET['name'])."')) ) group by replace(lower(subject), 're: ', '') ) t on m.id=t.maxid group by replace(lower(m.subject), 're: ', '') order by m.id desc limit 0,".((int)($limit+1)));$cnt=0;$txt=((mysql_num_rows($q)>$limit)?1:0)."\r\n";if(mysql_num_rows(mquery("select name from users where name='".mysql_real_escape_string($_GET['user'])."'"))>0)$txt.="1";else$txt.="0";while($r=mysql_fetch_row($q) and $cnt<$limit) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4];++$cnt;}echo "0\r\n".$cnt."\r\n".$txt;}elseif(isset($_GET['user']) and (isset($_GET['subj']) or isset($_GET['id']))) {if(isset($_GET['subj']))$subj=$_GET['subj'];else$subj=mysql_fetch_row(mquery("select replace(lower(subject), 're: ', '') from messages where id='".(int)$_GET['id']."'"))[0];if(isset($_GET['limit']))$limit=$_GET['limit'];else$limit=1000;$q=mquery("select id, sender, subject, date, if(`read` is not null, 1, 0), marked, attachments, message from messages where ( (sender='".mysql_real_escape_string($_GET['user'])."' and receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromreceived=0) or (receiver='".mysql_real_escape_string($_GET['user'])."' and sender='".mysql_real_escape_string($_GET['name'])."' and deletedfromsent=0) or (receiver='".mysql_real_escape_string($_GET['user'])."' and receiver in (select groupid from messages_groups_members where user='".mysql_real_escape_string($_GET['name'])."')) ) and replace(lower(subject), 're: ', '')=lower('".mysql_real_escape_string($subj)."') order by id desc limit 0,".((int)($limit+1)));$txt="\r\n".((mysql_num_rows($q)>$limit)?1:0)."\r\n";if(mysql_num_rows(mquery("select name from users where name='".mysql_real_escape_string($_GET['user'])."'"))>0 or mysql_num_rows(mquery("select id from messages_groups where id='".mysql_real_escape_string($_GET['user'])."'"))>0)$txt.="1";else$txt.="0";$cnt=0;while($r=mysql_fetch_row($q) and $cnt<$limit) {if(strpos($_GET['user'],"[")===0) $r[4]=1;$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4]."\r\n".$r[5]."\r\n".$r[6]."\r\n".$r[7]."\r\n\004END\004";++$cnt;}echo "0\r\n".$cnt.$txt;mquery("update messages set `read`=".time()." where `read` is null and sender='".mysql_real_escape_string($_GET['user'])."' and receiver='".mysql_real_escape_string($_GET['name'])."' and replace(lower(subject), 're: ', '')=lower('".mysql_real_escape_String($subj)."')");}}else {switch($_GET['sp']) {case "new": {$q=mquery("select replace(lower(subject),'re: ','') as subject, sender, date, 0, id from messages where id in (select max(id) from messages where (receiver='".mysql_real_escape_string($_GET['name'])."') and `read` is null group by replace(lower(subject), 're: ', ''),sender) and ((receiver='".mysql_real_escape_string($_GET['name'])."')) group by replace(lower(subject), 're: ', ''),sender order by id desc");$txt="0\r\n";$txt.="0";$cnt=0;while($r=mysql_fetch_row($q)) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4];++$cnt;}echo "0\r\n".$cnt."\r\n".$txt;break;}case "flagged": {$q=mquery("select id, sender, subject, date, if(`read` is not null, 1, 0), marked, attachments, message from messages where receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromreceived=0 and marked=1 order by id desc");$txt="\r\n0\r\n";$txt.="0";$cnt=0;while($r=mysql_fetch_row($q)) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4]."\r\n".$r[5]."\r\n".$r[6]."\r\n".$r[7]."\r\n\004END\004";++$cnt;}echo "0\r\n".$cnt.$txt;mquery("update messages set `read`=".time()." where `read` is null and receiver='".mysql_real_escape_string($_GET['name'])."' and marked=1");break;
}case "search": {$q=mquery("select id, sender, subject, date, if(`read` is not null, 1, 0), marked, attachments, message from messages where receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromreceived=0 and lower(message) like '%".mysql_real_escape_string($_GET['search'])."%' order by id desc limit 0,100");$txt="\r\n0\r\n";$txt.="0";$cnt=0;while($r=mysql_fetch_row($q)) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4]."\r\n".$r[5]."\r\n".$r[6]."\r\n".$r[7]."\r\n\004END\004";++$cnt;}echo "0\r\n".$cnt.$txt;mquery("update messages set `read`=".time()." where `read` is null and receiver='".mysql_real_escape_string($_GET['name'])."' and lower(message) like '%".mysql_real_escape_string($_GET['search'])."%' order by id desc limit 100");
break;}}}?>